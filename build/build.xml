<?xml version="1.0" encoding="UTF-8"?>
<project name="lb_js_scalableApp" basedir="." default="build">
  <description>
  Build script for
  The Scalable JavaScript Application Framework
  by Legal-Box, Paris

  Author: Eric Bréchemier &lt;legalbox@eric.brechemier.name>
  Copyright: Legal-Box SAS (c) 2010-2011, All Rights Reserved
  License: BSD License - http://creativecommons.org/licenses/BSD/
  Version: 2011-05-27

  Based on Build script for bezen.org JavaScript library
  CC-BY: Eric Bréchemier - http://bezen.org/javascript/
  </description>

  <target name="build"
    depends="doc,check,combine,compress"
  />

  <target name="clean" description="Remove previous temps">
    <delete dir="out"/>
  </target>

  <taskdef name="jslint4java"
           classname="com.googlecode.jslint4java.ant.JSLintTask"
           classpath="lib/jslint4java/jslint4java-1.4.7.jar" />
  <!--
  Check a set of JavaScript files with JSLint, using jslint4java

  Usage:
    * Check a single file
    <jslint file="../src/singleFile.js" />

    * Check all JavaScript files (*.js) in a directory (non-recursive)
    <jslint dir="../src/wholeDir/" />

    * Check all JavaScript files in a directory, recursively
    <jslint dir="../src" file="**/*.js" />
  -->
  <macrodef name="jslint">
    <attribute name="file" default="*.js" />
    <attribute name="dir"  default="." />
    <sequential>
      <echo>jslint: checking @{file} in @{dir}</echo>
      <jslint4java jslint="lib/jslint/fulljslint.js"
        encoding="UTF-8" haltOnFailure="true">
        <formatter type="plain" />
        <!-- The two file sets are combined to handle two use cases:
          1) only file attribute is present
          2) only dir attribute, or both file and dir attributes are present
        -->
        <fileset file="@{file}" />
        <fileset dir="@{dir}" includes="@{file}" />
      </jslint4java>
    </sequential>
  </macrodef>

  <target name="checkLib"
          description="Check Google Closure source files with JSLint">
    <!-- food for thought: fails with terrible errors -->
    <jslint dir="../src/closure" />
  </target>

  <target name="checkSrc"
          description="Check JavaScript source files with JSLint">
    <jslint dir="../src" />
  </target>

  <target name="checkTest" description="Check test files with JSLint">
    <jslint dir="../test" />
  </target>

  <target name="check" description="Check JavaScript files with JSLint" 
          depends="checkSrc, checkTest"
  />

  <macrodef name="naturaldocs">
    <attribute name="in" description="path to input folder for JS files" />
    <attribute name="out" description="path to folder for HTML output" />
    <attribute name="config" description="path to folder for configuration" />
    <sequential>
      <echo>naturaldocs: copy configuration to @{config}</echo>
      <copy file="lib/naturaldocs/Config/Menu.txt" todir="@{config}" />
      <echo>naturaldocs: started processing @{in} => @{out}</echo>
      <exec executable="perl" dir="${basedir}"
        failonerror="true"
      >
        <arg line="lib/naturaldocs/NaturalDocs" />
        <arg line="-i @{in}" />
        <arg line="-o HTML @{out}" />
        <arg line="-cs UTF-8" />
        <arg line="-p @{config}" />
      </exec>
      <echo>naturaldocs: completed @{in} => @{out}</echo>
      <echo/>
    </sequential>
  </macrodef>

  <target name="document"
    description="Document JavaScript source files with Natural Docs">
    <mkdir dir="out/doc/config"/>
    <naturaldocs in="../src" out="out/doc" config="out/doc/config" />
  </target>

  <target name="doc" depends="document" description="alias for document" />

  <macrodef name="combiner">
    <attribute name="in" />
    <attribute name="out" />
    <sequential>
      <echo>combiner: started processing @{in} => @{out}</echo>
      <java jar="lib/combiner/combiner-0.0.1.jar"
          fork="true"
          failonerror="true"
      >
        <arg value="-v" />
        <arg line="--charset UTF-8" />
        <arg line="-o @{out}" />
        <arg line="@{in}" />
      </java>
      <echo>combiner: completed @{in} => @{out}</echo>
      <echo/>
    </sequential>
  </macrodef>

  <target name="combine-with-combiner" description="Combine JavaScript files with Combiner">
    <mkdir dir="out/js"/>
    <fileset id="allinfiles" dir="../src" includes="*.js" />
    <pathconvert property="allin" pathsep=" " refid="allinfiles" />
    <combiner in="${allin}" out="out/js/lb-full.js" />
  </target>

  <target name="combine" description="Combine JavaScript files using concat task">
    <!-- Temporary replacement for Combiner to avoid issue: wrong order of dependencies -->
    <mkdir dir="out/js"/>
    <concat binary="true" destfile="out/js/lb-full.js">
      <!-- Google Closure (extracts) -->
      <file file="../src/closure/goog.js"/>
      <file file="../src/closure/goog.array.js"/>
      <file file="../src/closure/goog.string.js"/>
      <file file="../src/closure/goog.object.js"/>
      <file file="../src/closure/goog.structs.js"/>
      <file file="../src/closure/goog.iter.js"/>
      <file file="../src/closure/goog.structs.Map.js"/>
      <file file="../src/closure/goog.structs.Set.js"/>
      <file file="../src/closure/goog.debug.js"/>
      <file file="../src/closure/goog.debug.LogRecord.js"/>
      <file file="../src/closure/goog.debug.LogBuffer.js"/>
      <file file="../src/closure/goog.debug.Logger.js"/>
      <file file="../src/closure/goog.debug.RelativeTimeProvider.js"/>
      <file file="../src/closure/goog.debug.Formatter.js"/>
      <file file="../src/closure/goog.debug.Console.js"/>
      <file file="../src/closure/goog.userAgent.js"/>
      <file file="../src/closure/goog.dom.BrowserFeature.js"/>
      <file file="../src/closure/goog.dom.TagName.js"/>
      <file file="../src/closure/goog.dom.classes.js"/>
      <file file="../src/closure/goog.math.Coordinate.js"/>
      <file file="../src/closure/goog.math.Size.js"/>
      <file file="../src/closure/goog.dom.js"/>
      <file file="../src/closure/goog.debug.errorHandlerWeakDep.js"/>
      <file file="../src/closure/goog.Disposable.js"/>
      <file file="../src/closure/goog.events.Event.js"/>
      <file file="../src/closure/goog.events.EventType.js"/>
      <file file="../src/closure/goog.events.BrowserFeature.js"/>
      <file file="../src/closure/goog.reflect.js"/>
      <file file="../src/closure/goog.events.BrowserEvent.js"/>
      <file file="../src/closure/goog.events.EventWrapper.js"/>
      <file file="../src/closure/goog.events.Listener.js"/>
      <file file="../src/closure/goog.structs.SimplePool.js"/>
      <file file="../src/closure/goog.userAgent.jscript.js"/>
      <file file="../src/closure/goog.events.pools.js"/>
      <file file="../src/closure/goog.events.js"/>
      <file file="../src/closure/goog.events.EventTarget.js"/>
      <file file="../src/closure/goog.Timer.js"/>
      <file file="../src/closure/goog.events.EventHandler.js"/>
      <file file="../src/closure/goog.history.EventType.js"/>
      <file file="../src/closure/goog.history.Event.js"/>
      <file file="../src/closure/goog.History.js"/>
      <file file="../src/closure/goog.json.js"/>
      <file file="../src/closure/goog.net.ErrorCode.js"/>
      <file file="../src/closure/goog.net.EventType.js"/>
      <file file="../src/closure/goog.net.HttpStatus.js"/>
      <file file="../src/closure/goog.net.XmlHttpFactory.js"/>
      <file file="../src/closure/goog.net.WrapperXmlHttpFactory.js"/>
      <file file="../src/closure/goog.net.XmlHttp.js"/>
      <file file="../src/closure/goog.net.xhrMonitor.js"/>
      <file file="../src/closure/goog.uri.utils.js"/>
      <file file="../src/closure/goog.net.XhrIo.js"/>
      <!-- Scalable JavaScript Application -->
      <file file="../src/lb.js"/>
      <file file="../src/lb.base.js"/>
      <file file="../src/lb.base.type.js"/>
      <file file="../src/lb.base.object.js"/>
      <file file="../src/lb.base.array.js"/>
      <file file="../src/lb.base.config.js"/>
      <file file="../src/lb.base.dom.js"/>
      <file file="../src/lb.base.dom.css.js"/>
      <file file="../src/lb.base.dom.Listener.js"/>
      <file file="../src/lb.base.dom.factory.js"/>
      <file file="../src/lb.base.history.js"/>
      <file file="../src/lb.base.i18n.js"/>
      <file file="../src/lb.base.i18n.data.js"/>
      <file file="../src/lb.base.log.js"/>
      <file file="../src/lb.base.string.js"/>
      <file file="../src/lb.base.template.js"/>
      <file file="../src/lb.base.template.string.js"/>
      <file file="../src/lb.base.template.html.js"/>
      <file file="../src/lb.base.template.i18n.js"/>
      <file file="../src/lb.base.json.js"/>
      <file file="../src/lb.base.ajax.js"/>
      <file file="../src/lb.core.js"/>
      <file file="../src/lb.core.events.js"/>
      <file file="../src/lb.core.events.publisher.js"/>
      <file file="../src/lb.core.events.Subscriber.js"/>
      <file file="../src/lb.core.application.js"/>
      <file file="../src/lb.core.Sandbox.js"/>
      <file file="../src/lb.core.plugins.js"/>
      <file file="../src/lb.core.plugins.css.js"/>
      <file file="../src/lb.core.plugins.dom.js"/>
      <file file="../src/lb.core.plugins.events.js"/>
      <file file="../src/lb.core.plugins.i18n.js"/>
      <file file="../src/lb.core.plugins.server.js"/>
      <file file="../src/lb.core.plugins.url.js"/>
      <file file="../src/lb.core.plugins.utils.js"/>
      <file file="../src/lb.core.plugins.builder.js"/>
      <file file="../src/lb.core.Module.js"/>
      <file file="../src/lb.data.js" />
      <file file="../src/lb.ui.js" />
    </concat>
  </target>

  <macrodef name="yuicompressor">
    <attribute name="in" />
    <attribute name="out" />
    <sequential>
      <echo>yuicompressor: started processing @{in} => @{out}</echo>
      <java jar="lib/yuicompressor/yuicompressor-2.4.2.jar"
          fork="true"
          failonerror="true"
      >
        <arg value="-v" />
        <arg line="--charset UTF-8" />
        <arg line="-o @{out}" />
        <arg line="@{in}" />
      </java>
      <echo>yuicompressor: completed @{in} => @{out}</echo>
      <echo/>
    </sequential>
  </macrodef>

  <target name="setToday">
    <tstamp>
      <format property="TODAY" pattern="yyyy-MM-dd" timezone="GMT" />
    </tstamp>
  </target>

  <target name="compress"
   description="Compress JavaScript files with YUI Compressor"
   depends="setToday"
  >
    <yuicompressor in="out/js/lb-full.js"
                   out="out/js/lb-min.js" />

    <copy file="out/js/lb-min.js" tofile="out/js/lb-min-${TODAY}.js" />
  </target>

</project>
